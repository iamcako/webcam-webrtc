<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DMS – Viewer</title>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body>
  <main>
    <h1>İzleyici (WebRTC)</h1>
    <div class="card">
      <label>Oda Kodu: <input id="room" placeholder="sabah-spor" /></label>
      <div class="row">
        <button id="connectBtn">İzlemeye Başla</button>
        <button id="hangupBtn" disabled>Bağlantıyı Kes</button>
      </div>
      <p id="status">Durum: Bekleniyor…</p>
    </div>

    <div class="card">
      <h3>Canlı Yayın</h3>
      <video id="remoteVideo" playsinline autoplay muted></video>
      <p class="note">Eğer video otomatik başlamazsa dokunarak başlat.</p>
    </div>
  </main>

  <script>
    const connectBtn = document.getElementById('connectBtn');
    const hangupBtn  = document.getElementById('hangupBtn');
    const roomInput  = document.getElementById('room');
    const statusEl   = document.getElementById('status');
    const remoteVideo = document.getElementById('remoteVideo');

    let ws;
    let pc;
    const viewerId = (crypto.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2);
    const iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];

    connectBtn.onclick = async () => {
      const room = (roomInput.value || '').trim();
      if (!room) { alert('Oda kodu gir'); return; }

      const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
      ws = new WebSocket(`${wsProto}://${location.host}/ws`);

      ws.onopen = async () => {
        ws.send(JSON.stringify({ type: 'join', role: 'viewer', room, viewerId }));
        statusEl.textContent = 'Durum: Broadcaster bekleniyor veya sinyalleşme başlıyor…';
        pc = new RTCPeerConnection({ iceServers });

        pc.ontrack = (event) => {
          if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
          }
        };

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            ws.send(JSON.stringify({ type: 'ice-candidate', candidate: e.candidate }));
          }
        };

        const offer = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true });
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: 'offer', sdp: offer }));
        connectBtn.disabled = true;
        hangupBtn.disabled  = false;
      };

      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'answer') {
          await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
          statusEl.textContent = 'Durum: Bağlandı.';
        }
        if (msg.type === 'ice-candidate') {
          if (msg.candidate) {
            try { await pc.addIceCandidate(msg.candidate); } catch (e) {}
          }
        }
        if (msg.type === 'end') {
          statusEl.textContent = 'Durum: Yayıncı ayrıldı.';
          cleanup();
        }
        if (msg.type === 'error') {
          statusEl.textContent = 'Hata: ' + msg.message;
        }
      };

      ws.onclose = () => {
        statusEl.textContent = 'Durum: Bağlantı kapandı.';
      };
    };

    function cleanup() {
      if (pc) {
        try { pc.close(); } catch(e){}
        pc = null;
      }
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
      connectBtn.disabled = false;
      hangupBtn.disabled = true;
    }

    hangupBtn.onclick = cleanup;
  </script>
</body>
</html>
